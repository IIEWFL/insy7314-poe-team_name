version: 2.1

# Orbs for extended functionality
orbs:
  node: circleci/node@5.1.0

# Pipeline parameters for GitHub Actions integration
parameters:
  GHA_Event:
    type: string
    default: ""
  GHA_Actor:
    type: string
    default: ""
  GHA_Action:
    type: string
    default: ""
  GHA_Meta:
    type: string
    default: ""

# Reusable executors
executors:
  node-executor:
    docker:
      - image: cimg/node:20.10.0
    working_directory: ~/project

  security-executor:
    docker:
      - image: cimg/node:20.10.0
    working_directory: ~/project

  sonarqube-executor:
    docker:
      - image: cimg/node:20.10.0
      - image: sonarqube:community
    working_directory: ~/project

  node-mongo-executor:
    docker:
      - image: cimg/node:20.10.0
      - image: mongo:6.0
    working_directory: ~/project

# Reusable commands
commands:
  install-dependencies:
    description: "Install npm dependencies with caching"
    parameters:
      project-path:
        type: string
    steps:
      - restore_cache:
          keys:
            - v1-deps-<< parameters.project-path >>-{{ checksum "<< parameters.project-path >>/package-lock.json" }}
            - v1-deps-<< parameters.project-path >>-
      - run:
          name: Install Dependencies
          command: |
            cd << parameters.project-path >>
            echo "=== INSTALLING DEPENDENCIES ==="
            echo "Current directory: $(pwd)"
            echo "Package.json exists: $(test -f package.json && echo 'YES' || echo 'NO')"
            echo "Package-lock.json exists: $(test -f package-lock.json && echo 'YES' || echo 'NO')"
            # Use npm install instead of npm ci to handle lock file issues
            npm install --legacy-peer-deps
            echo "=== DEPENDENCIES INSTALLED ==="
            echo "Node modules created: $(test -d node_modules && echo 'YES' || echo 'NO')"
            echo "MongoDB driver installed: $(test -d node_modules/mongodb && echo 'YES' || echo 'NO')"
      - save_cache:
          key: v1-deps-<< parameters.project-path >>-{{ checksum "<< parameters.project-path >>/package-lock.json" }}
          paths:
            - << parameters.project-path >>/node_modules

  setup-mongodb-docker:
    description: "Set up MongoDB using Docker"
    parameters:
      project-path:
        type: string
        default: ""
    steps:
      - run:
          name: Check MongoDB Container Status
          command: |
            echo "=== MONGODB SETUP DEBUG ==="
            echo "Checking Docker containers..."
            docker ps -a
            echo "Checking MongoDB container logs..."
            docker logs $(docker ps -q --filter "ancestor=mongo:6.0") || echo "No MongoDB container found"
            echo "=== END MONGODB DEBUG ==="
      - run:
          name: Wait for MongoDB to be ready
          command: |
            echo "=== WAITING FOR MONGODB ==="
            echo "Current directory: $(pwd)"
            echo "Project path: << parameters.project-path >>"
            
            # Check if dependencies are installed
            if [ -n "<< parameters.project-path >>" ]; then
              echo "Checking for MongoDB driver in << parameters.project-path >>..."
              if [ -d "<< parameters.project-path >>/node_modules/mongodb" ]; then
                echo "âœ“ MongoDB driver found in project node_modules"
              else
                echo "âœ— MongoDB driver NOT found in project node_modules"
                echo "Listing node_modules:"
                ls -la << parameters.project-path >>/node_modules/ | head -20
              fi
            fi
            
            echo "Testing MongoDB connection with extensive logging..."
            
            for i in {1..40}; do
              echo "=== Attempt $i/40 ==="
              
              # Check if MongoDB port is open
              echo "1. Checking if MongoDB port 27017 is open..."
              if nc -z localhost 27017; then
                echo "âœ“ MongoDB port 27017 is open"
                
                # Check MongoDB container status
                echo "2. Checking MongoDB container status..."
                docker ps --filter "ancestor=mongo:6.0" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
                
                # Try multiple connection methods
                echo "3. Testing connection with Node.js script..."
                
                # Create a test script with better error handling
                cat > /tmp/mongo_test.js << 'EOF'
                console.log("=== MONGODB CONNECTION TEST ===");
                console.log("Node.js version:", process.version);
                
                try {
                  console.log("Attempting to require mongodb...");
                  const { MongoClient } = require('mongodb');
                  console.log("âœ“ MongoDB module loaded successfully");
                  
                  const uri = 'mongodb://localhost:27017/INSY7314';
                  console.log("Connection URI:", uri);
                  
                  const client = new MongoClient(uri, {
                    serverSelectionTimeoutMS: 5000,
                    connectTimeoutMS: 5000,
                    socketTimeoutMS: 5000
                  });
                  
                  console.log("Attempting to connect...");
                  await client.connect();
                  console.log("âœ“ Connected to MongoDB");
                  
                  console.log("Sending ping command...");
                  const result = await client.db().admin().ping();
                  console.log("âœ“ Ping result:", result);
                  
                  console.log("Listing databases...");
                  const dbs = await client.db().admin().listDatabases();
                  console.log("âœ“ Available databases:", dbs.databases.map(db => db.name));
                  
                  await client.close();
                  console.log("âœ“ Connection closed");
                  console.log("=== CONNECTION TEST: SUCCESS ===");
                  process.exit(0);
                } catch (error) {
                  console.log("=== CONNECTION TEST: FAILED ===");
                  console.log("Error name:", error.name);
                  console.log("Error message:", error.message);
                  console.log("Error code:", error.code);
                  console.log("Error stack:", error.stack);
                  
                  // Try alternative connection methods
                  console.log("=== ALTERNATIVE CONNECTION ATTEMPTS ===");
                  
                  // Try without database name
                  try {
                    console.log("Trying connection without database name...");
                    const { MongoClient } = require('mongodb');
                    const client = new MongoClient('mongodb://localhost:27017/', {
                      serverSelectionTimeoutMS: 3000
                    });
                    await client.connect();
                    console.log("âœ“ Connected without database name");
                    await client.close();
                  } catch (e) {
                    console.log("âœ— Failed without database name:", e.message);
                  }
                  
                  process.exit(1);
                }
EOF

                # Run the test script from the project directory to ensure correct node_modules path
                if [ -n "<< parameters.project-path >>" ] && [ -d "<< parameters.project-path >>/node_modules" ]; then
                  echo "Running test from project directory: << parameters.project-path >>"
                  cd "<< parameters.project-path >>"
                  if node /tmp/mongo_test.js; then
                    echo "ðŸŽ‰ MongoDB connection successful!"
                    exit 0
                  else
                    echo "MongoDB connection failed, retrying..."
                  fi
                  cd -
                else
                  echo "Running test from current directory"
                  if node /tmp/mongo_test.js; then
                    echo "ðŸŽ‰ MongoDB connection successful!"
                    exit 0
                  else
                    echo "MongoDB connection failed, retrying..."
                  fi
                fi
                
              else
                echo "âœ— MongoDB port 27017 is not open yet"
                echo "Checking Docker container status..."
                docker ps -a | grep mongo || echo "No MongoDB containers found"
              fi
              
              echo "Waiting 2 seconds before retry..."
              sleep 2
            done
            
            echo "=== MONGODB SETUP FAILED ==="
            echo "MongoDB failed to start or become responsive after 40 attempts"
            echo "Final Docker container status:"
            docker ps -a
            echo "Final MongoDB container logs:"
            docker logs $(docker ps -q --filter "ancestor=mongo:6.0") || echo "No MongoDB container"
            exit 1

  setup-sonarqube:
    description: "Set up and wait for SonarQube to be ready"
    steps:
      - run:
          name: Wait for SonarQube to start
          command: |
            echo "Waiting for SonarQube to be ready..."
            for i in {1..60}; do
              if curl -s http://sonarqube:9000/api/system/status | grep -q "UP"; then
                echo "SonarQube is ready!"
                exit 0
              fi
              echo "Waiting for SonarQube... ($i/60)"
              sleep 5
            done
            echo "SonarQube failed to start in time"
            exit 1

  run-sonar-scanner:
    description: "Run SonarQube analysis"
    parameters:
      project-path:
        type: string
      project-key:
        type: string
      project-name:
        type: string
    steps:
      - run:
          name: Install SonarScanner
          command: |
            cd << parameters.project-path >>
            wget -q https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
            unzip -q sonar-scanner-cli-5.0.1.3006-linux.zip
      - run:
          name: Run SonarQube Analysis
          command: |
            cd << parameters.project-path >>
            ./sonar-scanner-5.0.1.3006-linux/bin/sonar-scanner \
              -Dsonar.projectKey=<< parameters.project-key >> \
              -Dsonar.projectName=<< parameters.project-name >> \
              -Dsonar.projectVersion=1.0 \
              -Dsonar.host.url=http://sonarqube:9000 \
              -Dsonar.login=admin \
              -Dsonar.password=admin \
              -Dsonar.sources=src,controllers,models,routes,middleware \
              -Dsonar.exclusions=**/node_modules/**,**/coverage/**,**/*.d.ts

# Jobs
jobs:
  # ==================== CUSTOMER PORTAL JOBS ====================
  
  customer-backend-build:
    executor: node-executor
    steps:
      - checkout
      - install-dependencies:
          project-path: "CustomerPortal/Backend"
      - persist_to_workspace:
          root: .
          paths:
            - CustomerPortal/Backend

  customer-backend-sast:
    executor: security-executor
    steps:
      - checkout
      - install-dependencies:
          project-path: "CustomerPortal/Backend"
      - run:
          name: Install Python and pip
          command: |
            sudo apt-get update
            sudo apt-get install -y python3-pip
      - run:
          name: Install Semgrep (SAST)
          command: |
            python3 -m pip install --upgrade pip
            pip3 install semgrep
      - run:
          name: Run Semgrep SAST Scan
          command: |
            cd CustomerPortal/Backend
            semgrep scan --config=auto --json --output=semgrep-report.json || true
      - run:
          name: Install NodeJsScan (SAST)
          command: |
            pip3 install nodejsscan
      - run:
          name: Run NodeJsScan
          command: |
            cd CustomerPortal/Backend
            nodejsscan --directory . --output nodejsscan-report.json || true
      - store_artifacts:
          path: CustomerPortal/Backend/semgrep-report.json
      - store_artifacts:
          path: CustomerPortal/Backend/nodejsscan-report.json

  customer-backend-sca:
    executor: security-executor
    steps:
      - checkout
      - install-dependencies:
          project-path: "CustomerPortal/Backend"
      - run:
          name: Run npm audit
          command: |
            cd CustomerPortal/Backend
            npm audit --json > npm-audit-report.json || true
      - run:
          name: Install and Run Snyk
          command: |
            npm install -g snyk
            cd CustomerPortal/Backend
            # Snyk will fail if no token, but continue anyway
            snyk test --json > snyk-report.json 2>/dev/null || echo "Snyk test completed (auth may be required)"
      - store_artifacts:
          path: CustomerPortal/Backend/npm-audit-report.json
      - store_artifacts:
          path: CustomerPortal/Backend/snyk-report.json

  customer-backend-sonarqube:
    executor: sonarqube-executor
    steps:
      - checkout
      - install-dependencies:
          project-path: "CustomerPortal/Backend"
      - setup-sonarqube
      - run-sonar-scanner:
          project-path: "CustomerPortal/Backend"
          project-key: "customer-portal-backend"
          project-name: "Customer Portal Backend"

  customer-backend-api-tests:
    executor: node-mongo-executor
    steps:
      - checkout
      - install-dependencies:
          project-path: "CustomerPortal/Backend"
      - setup-mongodb-docker:
          project-path: "CustomerPortal/Backend"
      - run:
          name: Create Test Environment File
          command: |
            cd CustomerPortal/Backend
            echo "Creating test environment file..."
            echo "MONGODB_URI=mongodb://localhost:27017/INSY7314" > .env
            echo "PORT=8000" >> .env
            echo "JWT_SECRET=test_secret_key_for_ci" >> .env
            echo "USE_HTTPS=false" >> .env
            echo "Environment file created:"
            cat .env
      - run:
          name: Start Customer Backend Server
          command: |
            cd CustomerPortal/Backend
            echo "Starting Customer Backend Server..."
            npm start &
            echo "Server started in background"
          background: true
      - run:
          name: Wait for Server to Start
          command: |
            echo "Waiting for Customer Backend Server to start..."
            for i in {1..30}; do
              if curl -s http://localhost:8000 > /dev/null; then
                echo "âœ“ Server is ready and responding"
                exit 0
              fi
              echo "Waiting for server... ($i/30)"
              sleep 2
            done
            echo "âœ— Server failed to start"
            echo "Checking if process is running..."
            ps aux | grep node
            exit 1
      - run:
          name: Run Basic API Tests
          command: |
            echo "Testing customer API endpoints..."
            # Simple health check
            response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/api || echo "500")
            if [ "$response" = "200" ]; then
              echo "âœ“ Customer API health check: PASSED (Status: $response)"
            else
              echo "âœ— Customer API health check: FAILED (Status: $response)"
              echo "Full response:"
              curl -v http://localhost:8000/api || echo "Curl failed"
            fi
      - store_artifacts:
          path: CustomerPortal/Backend

  customer-frontend-build:
    executor: node-executor
    steps:
      - checkout
      - install-dependencies:
          project-path: "CustomerPortal/Frontend"
      - run:
          name: Build Frontend
          command: |
            cd CustomerPortal/Frontend
            npm run build || echo "Build may have warnings"
      - persist_to_workspace:
          root: .
          paths:
            - CustomerPortal/Frontend/build

  customer-frontend-security:
    executor: security-executor
    steps:
      - checkout
      - install-dependencies:
          project-path: "CustomerPortal/Frontend"
      - run:
          name: Run npm audit on Frontend
          command: |
            cd CustomerPortal/Frontend
            npm audit --json > npm-audit-report.json || true
      - store_artifacts:
          path: CustomerPortal/Frontend/npm-audit-report.json

  # ==================== EMPLOYEE PORTAL JOBS ====================

  employee-backend-build:
    executor: node-executor
    steps:
      - checkout
      - install-dependencies:
          project-path: "EmployeePortal/Backend"
      - persist_to_workspace:
          root: .
          paths:
            - EmployeePortal/Backend

  employee-backend-sast:
    executor: security-executor
    steps:
      - checkout
      - install-dependencies:
          project-path: "EmployeePortal/Backend"
      - run:
          name: Install Python and pip
          command: |
            sudo apt-get update
            sudo apt-get install -y python3-pip
      - run:
          name: Install Semgrep (SAST)
          command: |
            python3 -m pip install --upgrade pip
            pip3 install semgrep
      - run:
          name: Run Semgrep SAST Scan
          command: |
            cd EmployeePortal/Backend
            semgrep scan --config=auto --json --output=semgrep-report.json || true
      - run:
          name: Install NodeJsScan (SAST)
          command: |
            pip3 install nodejsscan
      - run:
          name: Run NodeJsScan
          command: |
            cd EmployeePortal/Backend
            nodejsscan --directory . --output nodejsscan-report.json || true
      - store_artifacts:
          path: EmployeePortal/Backend/semgrep-report.json
      - store_artifacts:
          path: EmployeePortal/Backend/nodejsscan-report.json

  employee-backend-sca:
    executor: security-executor
    steps:
      - checkout
      - install-dependencies:
          project-path: "EmployeePortal/Backend"
      - run:
          name: Run npm audit
          command: |
            cd EmployeePortal/Backend
            npm audit --json > npm-audit-report.json || true
      - run:
          name: Install and Run Snyk
          command: |
            npm install -g snyk
            cd EmployeePortal/Backend
            # Snyk will fail if no token, but continue anyway
            snyk test --json > snyk-report.json 2>/dev/null || echo "Snyk test completed (auth may be required)"
      - store_artifacts:
          path: EmployeePortal/Backend/npm-audit-report.json
      - store_artifacts:
          path: EmployeePortal/Backend/snyk-report.json

  employee-backend-sonarqube:
    executor: sonarqube-executor
    steps:
      - checkout
      - install-dependencies:
          project-path: "EmployeePortal/Backend"
      - setup-sonarqube
      - run-sonar-scanner:
          project-path: "EmployeePortal/Backend"
          project-key: "employee-portal-backend"
          project-name: "Employee Portal Backend"

  employee-backend-api-tests:
    executor: node-mongo-executor
    steps:
      - checkout
      - install-dependencies:
          project-path: "EmployeePortal/Backend"
      - setup-mongodb-docker:
          project-path: "EmployeePortal/Backend"
      - run:
          name: Create Test Environment File
          command: |
            cd EmployeePortal/Backend
            echo "Creating test environment file..."
            echo "MONGODB_URI=mongodb://localhost:27017/INSY7314" > .env
            echo "PORT=8001" >> .env
            echo "JWT_SECRET=test_secret_key_for_ci" >> .env
            echo "USE_HTTPS=false" >> .env
            echo "Environment file created:"
            cat .env
      - run:
          name: Start Employee Backend Server
          command: |
            cd EmployeePortal/Backend
            echo "Starting Employee Backend Server..."
            npm start &
            echo "Server started in background"
          background: true
      - run:
          name: Wait for Server to Start
          command: |
            echo "Waiting for Employee Backend Server to start..."
            for i in {1..30}; do
              if curl -s http://localhost:8001 > /dev/null; then
                echo "âœ“ Server is ready and responding"
                exit 0
              fi
              echo "Waiting for server... ($i/30)"
              sleep 2
            done
            echo "âœ— Server failed to start"
            echo "Checking if process is running..."
            ps aux | grep node
            exit 1
      - run:
          name: Run Basic API Tests
          command: |
            echo "Testing employee API endpoints..."
            # Simple health check
            response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8001/api/employee || echo "500")
            if [ "$response" = "200" ]; then
              echo "âœ“ Employee API health check: PASSED (Status: $response)"
            else
              echo "âœ— Employee API health check: FAILED (Status: $response)"
              echo "Full response:"
              curl -v http://localhost:8001/api/employee || echo "Curl failed"
            fi
      - store_artifacts:
          path: EmployeePortal/Backend

  employee-frontend-build:
    executor: node-executor
    steps:
      - checkout
      - install-dependencies:
          project-path: "EmployeePortal/Frontend"
      - run:
          name: Build Frontend
          command: |
            cd EmployeePortal/Frontend
            npm run build || echo "Build may have warnings"
      - persist_to_workspace:
          root: .
          paths:
            - EmployeePortal/Frontend/build

  employee-frontend-security:
    executor: security-executor
    steps:
      - checkout
      - install-dependencies:
          project-path: "EmployeePortal/Frontend"
      - run:
          name: Run npm audit on Frontend
          command: |
            cd EmployeePortal/Frontend
            npm audit --json > npm-audit-report.json || true
      - store_artifacts:
          path: EmployeePortal/Frontend/npm-audit-report.json

# Workflows
workflows:
  version: 2
  
  # Main workflow triggered by GitHub Actions
  github-triggered-pipeline:
    when: << pipeline.parameters.GHA_Action >>
    jobs:
      # Customer Portal Backend
      - customer-backend-build
      - customer-backend-sast:
          requires:
            - customer-backend-build
      - customer-backend-sca:
          requires:
            - customer-backend-build
      - customer-backend-sonarqube:
          requires:
            - customer-backend-build
      - customer-backend-api-tests:
          requires:
            - customer-backend-build

      # Customer Portal Frontend
      - customer-frontend-build
      - customer-frontend-security:
          requires:
            - customer-frontend-build

      # Employee Portal Backend
      - employee-backend-build
      - employee-backend-sast:
          requires:
            - employee-backend-build
      - employee-backend-sca:
          requires:
            - employee-backend-build
      - employee-backend-sonarqube:
          requires:
            - employee-backend-build
      - employee-backend-api-tests:
          requires:
            - employee-backend-build

      # Employee Portal Frontend
      - employee-frontend-build
      - employee-frontend-security:
          requires:
            - employee-frontend-build
