version: 2.1

jobs:
  employee-backend-api-tests:
    docker:
      - image: cimg/node:20.10.0
      - image: mongo:6.0
    working_directory: ~/project
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            cd EmployeePortal/Backend
            npm install
      - run:
          name: Wait for MongoDB
          command: |
            for i in {1..30}; do
              if nc -z localhost 27017; then
                echo "MongoDB is ready!"
                exit 0
              fi
              sleep 2
            done
            echo "MongoDB failed to start"
            exit 1
      - run:
          name: Debug - Show server.js content
          command: |
            cd EmployeePortal/Backend
            echo "=== server.js CONTENT ==="
            cat server.js
            echo "=== END server.js ==="
      - run:
          name: Create test environment
          command: |
            cd EmployeePortal/Backend
            echo "MONGODB_URI=mongodb://localhost:27017/INSY7314" > .env
            echo "PORT=8001" >> .env
            echo "JWT_SECRET=test" >> .env
            echo "USE_HTTPS=false" >> .env
      - run:
          name: Kill anything on port 8001
          command: |
            pkill -f "node.*8001" || true
            sleep 2
      - run:
          name: Try to start server
          command: |
            cd EmployeePortal/Backend
            echo "=== Starting server ==="
            node server.js &
            SERVER_PID=$!
            echo $SERVER_PID > server.pid
            echo "Server started with PID: $SERVER_PID"
            sleep 5
      - run:
          name: Check server status
          command: |
            cd EmployeePortal/Backend
            echo "=== Checking if server process is alive ==="
            if ps -p $(cat server.pid) > /dev/null 2>&1; then
              echo "✓ Server process is running"
              echo "=== Testing endpoints ==="
              curl -s http://localhost:8001/api/employee > /dev/null && echo "✓ API endpoint responding" || echo "✗ API endpoint not responding"
              curl -s http://localhost:8001/ > /dev/null && echo "✓ Root endpoint responding" || echo "✗ Root endpoint not responding"
            else
              echo "✗ Server process died immediately"
              echo "=== Checking Node error ==="
              # Try to run server directly to see the error
              node server.js || echo "Node execution failed"
            fi
      - run:
          name: Cleanup
          command: |
            pkill -f "node.*8001" || true

workflows:
  version: 2
  test-all:
    jobs:
      - employee-backend-api-tests
