version: 2.1

jobs:
  employee-backend-api-tests:
    docker:
      - image: cimg/node:20.10.0
      - image: mongo:6.0
    working_directory: ~/project
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            cd EmployeePortal/Backend
            npm install
      - run:
          name: Wait for MongoDB
          command: |
            for i in {1..30}; do
              if nc -z localhost 27017; then
                echo "MongoDB is ready!"
                exit 0
              fi
              sleep 2
            done
            echo "MongoDB failed to start"
            exit 1
      - run:
          name: Create test environment
          command: |
            cd EmployeePortal/Backend
            echo "MONGODB_URI=mongodb://localhost:27017/INSY7314" > .env
            echo "PORT=8001" >> .env
            echo "JWT_SECRET=test" >> .env
            echo "USE_HTTPS=false" >> .env
      - run:
          name: Start server and test (all in one step)
          command: |
            cd EmployeePortal/Backend
            
            # Start server in background but keep it in this step
            node server.js &
            SERVER_PID=$!
            echo "Server started with PID: $SERVER_PID"
            
            # Wait a bit for server to start
            sleep 5
            
            # Check if server is running
            if ps -p $SERVER_PID > /dev/null; then
              echo "✓ Server process is running"
              
              # Test the endpoints
              echo "=== Testing endpoints ==="
              if curl -s http://localhost:8001/api/employee > /dev/null; then
                echo "✓ API endpoint responding"
              else
                echo "✗ API endpoint not responding"
              fi
              
              if curl -s http://localhost:8001/ > /dev/null; then
                echo "✓ Root endpoint responding"
              else
                echo "✗ Root endpoint not responding"
              fi
              
              # Kill the server
              kill $SERVER_PID
              echo "Server stopped"
            else
              echo "✗ Server process died immediately"
              # Try to see what error occurred
              echo "=== Checking server output ==="
              # Start server in foreground to see errors
              node server.js || echo "Server failed to start"
            fi

  customer-backend-api-tests:
    docker:
      - image: cimg/node:20.10.0
      - image: mongo:6.0
    working_directory: ~/project
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            cd CustomerPortal/Backend
            npm install
      - run:
          name: Wait for MongoDB
          command: |
            for i in {1..30}; do
              if nc -z localhost 27017; then
                echo "MongoDB is ready!"
                exit 0
              fi
              sleep 2
            done
            echo "MongoDB failed to start"
            exit 1
      - run:
          name: Create test environment
          command: |
            cd CustomerPortal/Backend
            echo "MONGODB_URI=mongodb://localhost:27017/INSY7314" > .env
            echo "PORT=8000" >> .env
            echo "JWT_SECRET=test" >> .env
            echo "USE_HTTPS=false" >> .env
      - run:
          name: Start server and test (all in one step)
          command: |
            cd CustomerPortal/Backend
            
            # Start server in background but keep it in this step
            node server.js &
            SERVER_PID=$!
            echo "Server started with PID: $SERVER_PID"
            
            # Wait a bit for server to start
            sleep 5
            
            # Check if server is running
            if ps -p $SERVER_PID > /dev/null; then
              echo "✓ Server process is running"
              
              # Test the endpoints
              echo "=== Testing endpoints ==="
              if curl -s http://localhost:8000/api/customer > /dev/null; then
                echo "✓ API endpoint responding"
              else
                echo "✗ API endpoint not responding"
              fi
              
              if curl -s http://localhost:8000/ > /dev/null; then
                echo "✓ Root endpoint responding"
              else
                echo "✗ Root endpoint not responding"
              fi
              
              # Kill the server
              kill $SERVER_PID
              echo "Server stopped"
            else
              echo "✗ Server process died immediately"
              # Try to see what error occurred
              echo "=== Checking server output ==="
              # Start server in foreground to see errors
              node server.js || echo "Server failed to start"
            fi

workflows:
  version: 2
  test-all:
    jobs:
      - employee-backend-api-tests
      - customer-backend-api-tests
