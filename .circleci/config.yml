version: 2.1

jobs:
  employee-backend-api-tests:
    docker:
      - image: cimg/node:20.10.0
      - image: mongo:6.0
    working_directory: ~/project
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-deps-EmployeePortal/Backend-{{ checksum "EmployeePortal/Backend/package-lock.json" }}
            - v1-deps-EmployeePortal/Backend-
      - run:
          name: Install ALL missing dependencies
          command: |
            cd EmployeePortal/Backend
            npm install express-validator express-brute express-brute-mongoose --legacy-peer-deps
            npm install --legacy-peer-deps
      - save_cache:
          key: v1-deps-EmployeePortal/Backend-{{ checksum "EmployeePortal/Backend/package-lock.json" }}
          paths:
            - EmployeePortal/Backend/node_modules
      - run:
          name: Wait for MongoDB
          command: |
            for i in {1..30}; do
              if nc -z localhost 27017; then
                echo "MongoDB is ready!"
                exit 0
              fi
              sleep 2
            done
            exit 1
      - run:
          name: Create test environment
          command: |
            cd EmployeePortal/Backend
            echo "MONGODB_URI=mongodb://localhost:27017/INSY7314" > .env
            echo "PORT=8001" >> .env
            echo "JWT_SECRET=test" >> .env
            echo "USE_HTTPS=false" >> .env
      - run:
          name: Start server and test
          command: |
            cd EmployeePortal/Backend
            
            # Start server in background
            node server.js &
            SERVER_PID=$!
            echo "Server started with PID: $SERVER_PID"
            
            # Wait for server to start
            sleep 10
            
            # Check if server is running
            if ps -p $SERVER_PID > /dev/null; then
              echo "✓ Server process is running"
              
              # Test the endpoints with actual response validation
              echo "=== Testing endpoints ==="
              
              # Test employee API endpoint and check response code
              response_code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8001/api/employee)
              echo "Employee API returned HTTP $response_code"
              
              # Accept 200 (success), 401 (unauthorized), 404 (not found) as valid responses
              # Reject 500 (server error) and 000 (connection refused)
              if [[ "$response_code" =~ ^(200|401|404)$ ]]; then
                echo "✓ Employee API endpoint responding correctly (HTTP $response_code)"
              else
                echo "✗ Employee API endpoint failed (HTTP $response_code)"
                exit 1
              fi
              
              # Test root endpoint too
              root_code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8001/)
              echo "Root endpoint returned HTTP $root_code"
              
              if [[ "$root_code" =~ ^(200|404)$ ]]; then
                echo "✓ Root endpoint responding (HTTP $root_code)"
              else
                echo "⚠ Root endpoint not standard (HTTP $root_code)"
              fi
              
              exit 0
            else
              echo "✗ Server process died"
              exit 1
            fi

  customer-backend-api-tests:
    docker:
      - image: cimg/node:20.10.0
      - image: mongo:6.0
    working_directory: ~/project
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-deps-CustomerPortal/Backend-{{ checksum "CustomerPortal/Backend/package-lock.json" }}
            - v1-deps-CustomerPortal/Backend-
      - run:
          name: Install ALL missing dependencies
          command: |
            cd CustomerPortal/Backend
            npm install express-validator express-brute express-brute-mongoose --legacy-peer-deps
            npm install --legacy-peer-deps
      - save_cache:
          key: v1-deps-CustomerPortal/Backend-{{ checksum "CustomerPortal/Backend/package-lock.json" }}
          paths:
            - CustomerPortal/Backend/node_modules
      - run:
          name: Wait for MongoDB
          command: |
            for i in {1..30}; do
              if nc -z localhost 27017; then
                echo "MongoDB is ready!"
                exit 0
              fi
              sleep 2
            done
            exit 1
      - run:
          name: Create test environment
          command: |
            cd CustomerPortal/Backend
            echo "MONGODB_URI=mongodb://localhost:27017/INSY7314" > .env
            echo "PORT=8000" >> .env
            echo "JWT_SECRET=test" >> .env
            echo "USE_HTTPS=false" >> .env
      - run:
          name: Start server and test
          command: |
            cd CustomerPortal/Backend
            
            # Start server in background
            node server.js &
            SERVER_PID=$!
            echo "Server started with PID: $SERVER_PID"
            
            # Wait for server to start
            sleep 10
            
            # Check if server is running
            if ps -p $SERVER_PID > /dev/null; then
              echo "✓ Server process is running"
              
              # Test the endpoints with actual response validation
              echo "=== Testing endpoints ==="
              
              # Test customer API endpoint and check response code
              response_code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/api/customer)
              echo "Customer API returned HTTP $response_code"
              
              # Accept 200 (success), 401 (unauthorized), 404 (not found) as valid responses
              # Reject 500 (server error) and 000 (connection refused)
              if [[ "$response_code" =~ ^(200|401|404)$ ]]; then
                echo "✓ Customer API endpoint responding correctly (HTTP $response_code)"
              else
                echo "✗ Customer API endpoint failed (HTTP $response_code)"
                exit 1
              fi
              
              # Test root endpoint too
              root_code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/)
              echo "Root endpoint returned HTTP $root_code"
              
              if [[ "$root_code" =~ ^(200|404)$ ]]; then
                echo "✓ Root endpoint responding (HTTP $root_code)"
              else
                echo "⚠ Root endpoint not standard (HTTP $root_code)"
              fi
              
              exit 0
            else
              echo "✗ Server process died"
              exit 1
            fi

workflows:
  version: 2
  test-all:
    jobs:
      - employee-backend-api-tests
      - customer-backend-api-tests
