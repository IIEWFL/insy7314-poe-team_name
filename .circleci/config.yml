version: 2.1

jobs:
  employee-backend-api-tests:
    docker:
      - image: cimg/node:20.10.0
      - image: mongo:6.0
    working_directory: ~/project
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-deps-EmployeePortal/Backend-{{ checksum "EmployeePortal/Backend/package-lock.json" }}
            - v1-deps-EmployeePortal/Backend-
      - run:
          name: Install dependencies with missing packages
          command: |
            cd EmployeePortal/Backend
            npm install express-validator express-brute --legacy-peer-deps
            npm install --legacy-peer-deps
      - save_cache:
          key: v1-deps-EmployeePortal/Backend-{{ checksum "EmployeePortal/Backend/package-lock.json" }}
          paths:
            - EmployeePortal/Backend/node_modules
      - run:
          name: Wait for MongoDB
          command: |
            for i in {1..30}; do
              if nc -z localhost 27017; then
                echo "MongoDB is ready!"
                exit 0
              fi
              sleep 2
            done
            exit 1
      - run:
          name: Create test environment
          command: |
            cd EmployeePortal/Backend
            echo "MONGODB_URI=mongodb://localhost:27017/INSY7314" > .env
            echo "PORT=8001" >> .env
            echo "JWT_SECRET=test" >> .env
            echo "USE_HTTPS=false" >> .env
      - run:
          name: Start server and test
          command: |
            cd EmployeePortal/Backend
            
            # Start server in background
            node server.js &
            SERVER_PID=$!
            echo "Server started with PID: $SERVER_PID"
            
            # Wait for server to start
            sleep 10
            
            # Check if server is running
            if ps -p $SERVER_PID > /dev/null; then
              echo "✓ Server process is running"
              
              # Test the endpoints
              echo "=== Testing endpoints ==="
              if curl -s http://localhost:8001/api/employee > /dev/null; then
                echo "✓ API endpoint responding"
                exit 0
              else
                echo "✗ API endpoint not responding"
                exit 1
              fi
            else
              echo "✗ Server process died"
              exit 1
            fi

  customer-backend-api-tests:
    docker:
      - image: cimg/node:20.10.0
      - image: mongo:6.0
    working_directory: ~/project
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-deps-CustomerPortal/Backend-{{ checksum "CustomerPortal/Backend/package-lock.json" }}
            - v1-deps-CustomerPortal/Backend-
      - run:
          name: Install dependencies with missing packages
          command: |
            cd CustomerPortal/Backend
            npm install express-validator express-brute --legacy-peer-deps
            npm install --legacy-peer-deps
      - save_cache:
          key: v1-deps-CustomerPortal/Backend-{{ checksum "CustomerPortal/Backend/package-lock.json" }}
          paths:
            - CustomerPortal/Backend/node_modules
      - run:
          name: Wait for MongoDB
          command: |
            for i in {1..30}; do
              if nc -z localhost 27017; then
                echo "MongoDB is ready!"
                exit 0
              fi
              sleep 2
            done
            exit 1
      - run:
          name: Create test environment
          command: |
            cd CustomerPortal/Backend
            echo "MONGODB_URI=mongodb://localhost:27017/INSY7314" > .env
            echo "PORT=8000" >> .env
            echo "JWT_SECRET=test" >> .env
            echo "USE_HTTPS=false" >> .env
      - run:
          name: Start server and test
          command: |
            cd CustomerPortal/Backend
            
            # Start server in background
            node server.js &
            SERVER_PID=$!
            echo "Server started with PID: $SERVER_PID"
            
            # Wait for server to start
            sleep 10
            
            # Check if server is running
            if ps -p $SERVER_PID > /dev/null; then
              echo "✓ Server process is running"
              
              # Test the endpoints
              echo "=== Testing endpoints ==="
              if curl -s http://localhost:8000/api/customer > /dev/null; then
                echo "✓ API endpoint responding"
                exit 0
              else
                echo "✗ API endpoint not responding"
                exit 1
              fi
            else
              echo "✗ Server process died"
              exit 1
            fi

workflows:
  version: 2
  test-all:
    jobs:
      - employee-backend-api-tests
      - customer-backend-api-tests
