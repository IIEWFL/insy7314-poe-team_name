name: Security Pipeline - Trigger CircleCI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  quick-security-scan:
    name: Quick Security Scan (GitHub)
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Customer Backend Dependencies with Legacy Peer Deps
        working-directory: CustomerPortal/Backend
        run: |
          echo "Installing dependencies for Customer Portal Backend..."
          if [ -f "package.json" ]; then
            npm ci --legacy-peer-deps || npm install --legacy-peer-deps
            echo "Running npm audit for Customer Portal..."
            npm audit --json --legacy-peer-deps > npm-audit-customer.json || true
          else
            echo "package.json not found in CustomerPortal/Backend"
            echo '{"error": "No package.json found"}' > npm-audit-customer.json
          fi
      
      - name: Install Employee Backend Dependencies with Legacy Peer Deps
        working-directory: EmployeePortal/Backend
        run: |
          echo "Installing dependencies for Employee Portal Backend..."
          if [ -f "package.json" ]; then
            npm ci --legacy-peer-deps || npm install --legacy-peer-deps
            echo "Running npm audit for Employee Portal..."
            npm audit --json --legacy-peer-deps > npm-audit-employee.json || true
          else
            echo "package.json not found in EmployeePortal/Backend"
            echo '{"error": "No package.json found"}' > npm-audit-employee.json
          fi
      
      - name: Install Semgrep
        run: |
          python3 -m pip install --upgrade pip
          pip3 install semgrep jq
      
      - name: Run Semgrep SAST Scan
        run: |
          echo "Running Semgrep scan..."
          semgrep scan --config=p/javascript --sarif --output=semgrep-results.sarif CustomerPortal/Backend EmployeePortal/Backend || echo "Semgrep scan completed with issues"
          semgrep scan --config=p/javascript --json CustomerPortal/Backend EmployeePortal/Backend > semgrep-temp.json || echo '{"runs":[]}' > semgrep-temp.json
          jq -r '.runs[].results[] | "Rule: \(.rule_id)\nFile: \(.path)\nLine: \(.start.line)\nMessage: \(.extra.message)\n---"' semgrep-temp.json > semgrep-results.txt || echo "No findings" > semgrep-results.txt
          rm -f semgrep-temp.json
          if [ ! -f "semgrep-results.sarif" ]; then
            echo '{"runs": []}' > semgrep-results.sarif
          fi
      
      - name: Upload Semgrep SARIF to GitHub
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep-results.sarif
      
      - name: Create Backup Files if Missing
        run: |
          if [ ! -f "CustomerPortal/Backend/npm-audit-customer.json" ]; then
            echo '{"vulnerabilities": {}, "metadata": {}}' > CustomerPortal/Backend/npm-audit-customer.json
          fi
          if [ ! -f "EmployeePortal/Backend/npm-audit-employee.json" ]; then
            echo '{"vulnerabilities": {}, "metadata": {}}' > EmployeePortal/Backend/npm-audit-employee.json
          fi
          if [ ! -f "semgrep-results.sarif" ]; then
            echo '{"runs": []}' > semgrep-results.sarif
          fi
          if [ ! -f "semgrep-results.txt" ]; then
            echo "No Semgrep findings" > semgrep-results.txt
          fi
      
      - name: Upload Security Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: github-quick-scan-reports
          path: |
            CustomerPortal/Backend/npm-audit-customer.json
            EmployeePortal/Backend/npm-audit-employee.json
            semgrep-results.sarif
            semgrep-results.txt
          retention-days: 7
      
      - name: Generate Quick Summary
        if: always()
        run: |
          echo "# Quick Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "semgrep-results.sarif" ]; then
            echo "Semgrep SAST scan completed" >> $GITHUB_STEP_SUMMARY
            echo "Human-readable findings saved to semgrep-results.txt" >> $GITHUB_STEP_SUMMARY
          else
            echo "Semgrep SAST scan failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "CustomerPortal/Backend/npm-audit-customer.json" ] && [ -f "EmployeePortal/Backend/npm-audit-employee.json" ]; then
            echo "npm audit completed for both portals" >> $GITHUB_STEP_SUMMARY
          else
            echo "npm audit failed for one or both portals" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Full security pipeline running on CircleCI..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View detailed results in CircleCI dashboard" >> $GITHUB_STEP_SUMMARY

  trigger-circleci-pipeline:
    name: Trigger CircleCI Comprehensive Security Pipeline
    runs-on: ubuntu-latest
    needs: quick-security-scan
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Trigger CircleCI Pipeline
        id: trigger-circleci
        uses: CircleCI-Public/trigger-circleci-pipeline-action@v1.2.0
        env:
          CCI_TOKEN: ${{ secrets.CCI_TOKEN }}
      
      - name: Show CircleCI Link
        run: |
          echo "# CircleCI Pipeline Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Comprehensive Security Testing In Progress" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following tests are running on CircleCI:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Customer Portal Backend" >> $GITHUB_STEP_SUMMARY
          echo "- SAST: Semgrep, NodeJsScan" >> $GITHUB_STEP_SUMMARY
          echo "- SCA: npm audit, OWASP Dependency-Check, Snyk" >> $GITHUB_STEP_SUMMARY
          echo "- SonarQube: Code quality & security hotspots" >> $GITHUB_STEP_SUMMARY
          echo "- API Tests: Newman + OWASP ZAP" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Employee Portal Backend" >> $GITHUB_STEP_SUMMARY
          echo "- SAST: Semgrep, NodeJsScan" >> $GITHUB_STEP_SUMMARY
          echo "- SCA: npm audit, OWASP Dependency-Check, Snyk" >> $GITHUB_STEP_SUMMARY
          echo "- SonarQube: Code quality & security hotspots" >> $GITHUB_STEP_SUMMARY
          echo "- API Tests: Newman" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Frontend Security" >> $GITHUB_STEP_SUMMARY
          echo "- SCA: npm audit (Customer & Employee)" >> $GITHUB_STEP_SUMMARY
          echo "- Build: Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View Full Results on CircleCI: https://app.circleci.com/pipelines/github/${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All security reports will be available as CircleCI artifacts" >> $GITHUB_STEP_SUMMARY

  circleci-status-check:
    name: CircleCI Status Check
    runs-on: ubuntu-latest
    needs: trigger-circleci-pipeline
    steps:
      - name: Wait for CircleCI
        run: |
          echo "Waiting for CircleCI pipeline to complete..."
          echo "This can take 10-15 minutes for comprehensive security testing"
          sleep 60
      
      - name: CircleCI Status
        run: |
          echo "# Security Pipeline Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All security scans have been initiated:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Quick scans completed on GitHub Actions" >> $GITHUB_STEP_SUMMARY
          echo "- Comprehensive tests running on CircleCI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Where to Find Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "GitHub (Immediate Results)" >> $GITHUB_STEP_SUMMARY
          echo "- Security Tab → Code Scanning (Semgrep SARIF)" >> $GITHUB_STEP_SUMMARY
          echo "- Artifacts → Quick scan reports" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "CircleCI (Comprehensive Results)" >> $GITHUB_STEP_SUMMARY
          echo "- SonarQube quality metrics" >> $GITHUB_STEP_SUMMARY
          echo "- OWASP Dependency-Check reports" >> $GITHUB_STEP_SUMMARY
          echo "- Newman API test results (HTML)" >> $GITHUB_STEP_SUMMARY
          echo "- OWASP ZAP security scan (HTML)" >> $GITHUB_STEP_SUMMARY
          echo "- Snyk vulnerability reports" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View CircleCI Dashboard: https://app.circleci.com/pipelines/github/${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
