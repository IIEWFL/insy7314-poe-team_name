name: Security Pipeline - Trigger CircleCI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  # ==================== RUN QUICK CHECKS ON GITHUB ====================
  # These run fast on GitHub Actions and provide immediate feedback
  
  quick-security-scan:
    name: Quick Security Scan (GitHub)
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Customer Backend Dependencies
        working-directory: CustomerPortal/Backend
        run: npm ci
      
      - name: Install Employee Backend Dependencies
        working-directory: EmployeePortal/Backend
        run: npm ci
      
      - name: Run Semgrep SAST (Quick)
        uses: returntocorp/semgrep-action@v1
        with:
          config: auto
          publishToken: ${{ secrets.SEMGREP_APP_TOKEN }}
          generateSarif: true
      
      - name: Upload Semgrep SARIF to GitHub
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
      
      - name: Run npm audit - Customer Backend
        working-directory: CustomerPortal/Backend
        run: |
          npm audit --json > npm-audit-customer.json || true
          npm audit || true
      
      - name: Run npm audit - Employee Backend
        working-directory: EmployeePortal/Backend
        run: |
          npm audit --json > npm-audit-employee.json || true
          npm audit || true
      
      - name: Upload Security Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: github-quick-scan-reports
          path: |
            CustomerPortal/Backend/npm-audit-customer.json
            EmployeePortal/Backend/npm-audit-employee.json
      
      - name: Generate Quick Summary
        if: always()
        run: |
          echo "# Quick Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "SUCCESS Semgrep SAST scan completed" >> $GITHUB_STEP_SUMMARY
          echo "SUCCESS npm audit completed for both portals" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "IN PROGRESS Full security pipeline running on CircleCI..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View detailed results in CircleCI dashboard" >> $GITHUB_STEP_SUMMARY

  # ==================== TRIGGER CIRCLECI FOR COMPREHENSIVE TESTING ====================
  
  trigger-circleci-pipeline:
    name: Trigger CircleCI Comprehensive Security Pipeline
    runs-on: ubuntu-latest
    needs: quick-security-scan  # Only trigger if quick scan passes
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Trigger CircleCI Pipeline
        id: trigger-circleci
        uses: CircleCI-Public/trigger-circleci-pipeline-action@v1.2.0
        env:
          CCI_TOKEN: ${{ secrets.CCI_TOKEN }}
      
      - name: Show CircleCI Link
        run: |
          echo "# CircleCI Pipeline Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Comprehensive Security Testing In Progress" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following tests are running on CircleCI:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Customer Portal Backend" >> $GITHUB_STEP_SUMMARY
          echo "- SAST: Semgrep, NodeJsScan" >> $GITHUB_STEP_SUMMARY
          echo "- SCA: npm audit, OWASP Dependency-Check, Snyk" >> $GITHUB_STEP_SUMMARY
          echo "- SonarCloud: Code quality & security hotspots" >> $GITHUB_STEP_SUMMARY
          echo "- API Tests: Newman + OWASP ZAP" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Employee Portal Backend" >> $GITHUB_STEP_SUMMARY
          echo "- SAST: Semgrep, NodeJsScan" >> $GITHUB_STEP_SUMMARY
          echo "- SCA: npm audit, OWASP Dependency-Check, Snyk" >> $GITHUB_STEP_SUMMARY
          echo "- SonarCloud: Code quality & security hotspots" >> $GITHUB_STEP_SUMMARY
          echo "- API Tests: Newman" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Frontend Security" >> $GITHUB_STEP_SUMMARY
          echo "- SCA: npm audit (Customer & Employee)" >> $GITHUB_STEP_SUMMARY
          echo "- Build: Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View Full Results on CircleCI: https://app.circleci.com/pipelines/github/${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All security reports will be available as CircleCI artifacts" >> $GITHUB_STEP_SUMMARY

  # ==================== POST RESULTS BACK TO GITHUB ====================
  
  circleci-status-check:
    name: CircleCI Status Check
    runs-on: ubuntu-latest
    needs: trigger-circleci-pipeline
    steps:
      - name: Wait for CircleCI
        run: |
          echo "Waiting for CircleCI pipeline to complete..."
          echo "This can take 10-15 minutes for comprehensive security testing"
          sleep 60  # Give CircleCI time to start
      
      - name: CircleCI Status
        run: |
          echo "# Security Pipeline Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All security scans have been initiated:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- SUCCESS Quick scans completed on GitHub Actions" >> $GITHUB_STEP_SUMMARY
          echo "- IN PROGRESS Comprehensive tests running on CircleCI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Where to Find Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### GitHub (Immediate Results)" >> $GITHUB_STEP_SUMMARY
          echo "- Security Tab -> Code Scanning (Semgrep SARIF)" >> $GITHUB_STEP_SUMMARY
          echo "- Artifacts -> Quick scan reports" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### CircleCI (Comprehensive Results)" >> $GITHUB_STEP_SUMMARY
          echo "- SonarCloud quality metrics" >> $GITHUB_STEP_SUMMARY
          echo "- OWASP Dependency-Check reports" >> $GITHUB_STEP_SUMMARY
          echo "- Newman API test results (HTML)" >> $GITHUB_STEP_SUMMARY
          echo "- OWASP ZAP security scan (HTML)" >> $GITHUB_STEP_SUMMARY
          echo "- Snyk vulnerability reports" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View CircleCI Dashboard: https://app.circleci.com/pipelines/github/${{ github.repository }}" >> $GITHUB_STEP_SUMMARY